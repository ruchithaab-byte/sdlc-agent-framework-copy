// Multi-Schema Flyway Configuration Template
// Use when single datasource hosts multiple schemas requiring independent migration paths
// Implements FlywayMigrationStrategy to control schema-specific migrations

package com.example.config;

import org.flywaydb.core.Flyway;
import org.springframework.boot.autoconfigure.flyway.FlywayMigrationStrategy;
import org.springframework.stereotype.Component;

import javax.sql.DataSource;

@Component
public class MultiSchemaMigrationStrategy implements FlywayMigrationStrategy {
    
    /**
     * Executes before default Flyway migration
     * Provides hook to create and run multiple Flyway instances for different schemas
     */
    @Override
    public void migrate(Flyway flyway) {
        // Extract datasource from auto-configured Flyway instance
        DataSource dataSource = flyway.getConfiguration().getDataSource();
        
        // Migrate test schema
        Flyway testFlyway = Flyway.configure()
            .dataSource(dataSource)
            .schemas("test")  // Target schema
            .locations("classpath:db/migration/test")  // Schema-specific location
            .table("test_schema_history")  // Dedicated history table
            .baselineOnMigrate(false)
            .load();
        testFlyway.migrate();
        
        // Migrate rating schema
        Flyway ratingFlyway = Flyway.configure()
            .dataSource(dataSource)
            .schemas("rating")  // Target schema
            .locations("classpath:db/migration/ratings")  // Schema-specific location
            .table("rating_schema_history")  // Dedicated history table
            .baselineOnMigrate(false)
            .load();
        ratingFlyway.migrate();
        
        // Optional: Suppress default migration if strategy handles all schemas
        // Otherwise, default migration runs on primary/default schema
    }
}

// Alternative: If you want to suppress default migration entirely
// Add to application.yml:
// spring.flyway.enabled=false
//
// Then manually trigger migrations in @PostConstruct or ApplicationRunner

